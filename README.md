# Refactor-COM-object-to-VBA-COM-wrapper-class

Aim: To refactor COM object to extract VBA COM wrapper class.  This is in regard for the requirement to construct VBA COM wrappers for classes at [DotNetLib]( https://github.com/MarkJohnstoneGitHub/DotNetLib).  As there are "numerous" properties and methods for each COM object to wrap aim to automate.

Suggestion for RubberDuck feature [Adding refactoring of COM objects](https://github.com/rubberduck-vba/Rubberduck/discussions/6111)

First stage obtaining the COM TypeLib info for an COM object.

Investigating methods in VBA and/or C# to obtain the type library info.

From the type library info for the required class obtain the class template to extract to a VBA COM wrapper classs.

- Preferrable utilize [RubberDuck](https://github.com/rubberduck-vba/Rubberduck) COM typelib wrappers
- Alternative using [twinBasic](https://github.com/twinbasic/twinbasic) addin for VBA could parse a reference pseudocode (From my understanding is based on the RD COM typelib wrappers and handlers). See [latest twinBasic IDE and you can see pseudocode](https://github.com/rubberduck-vba/Rubberduck/discussions/6111#discussioncomment-6041980)

**Issues:**
If issues with the TLI reference in [COM Refactoring.accdb](https://github.com/MarkJohnstoneGitHub/Refactor-COM-object-to-VBA-COM-wrapper-class/blob/main/COM%20Refactoring.accdb) see [tlbinf32.dll in a 64bits .Net application](https://stackoverflow.com/questions/42569377/tlbinf32-dll-in-a-64bits-net-application/42581513#42581513).

**Development:**

Outline for implemention of refactoring a Com Object to implement a VBA class COM wrapper.

1) Locate Com type library required and load using ComLibraryProvider class.
2) Find the Com object required by name returning the default interface [ComInterface](https://github.com/rubberduck-vba/Rubberduck/blob/next/Rubberduck.Parsing/ComReflection/ComInterface.cs) object.
3) Selecting various options for implementing :
- Intially the default implementation will be template of the ComInterface object required, using early binding, including descriptions and Rubberduck annotations for a predeclared class.
- Selecting various options would require a GUI etc. 
- Select which methods to implement.
- Ordering/grouping of methods/properties.
     - Ie. group as constructor  functions, properties,  methods in alpabetical order or same as Com object template.
     - Issue distinguishing between constructors and other similar factory functions that don't wish  to group as constructor overloads.
     - In Com objects created I'm placing these in the order as constructors, properties, methods.
           - Therefore possible could obtain a list  of constructor functions before the first property found.   
           - This might not be the case for all Com objects obtained to wrap. 
           - Might require an additional property for indentified constructor factory methods, which might require manual inspection to alter.
           - Note similar factory functions not to confuse with constructor factory functions.
     - Include class and method descriptions
     - Add Rubberduck annotations required. eg classs and  method description, hidden items, default, enumeration, predeclared class etc.
     - Option to implement as predeclared class.
-Early or late binding implementation of wrapping the Com object in VBA.
  
If allowing for various options create a copy of the Com object ComInterface according to selections. 
i.e. The list of methods is copied according to required methods required and ordering. 
Update ComInterface.IsPreDeclared property.
To allow for sorting/grouping of methods maybe have to expose some lists eg the methods list?

4) Build the VBA class from a ComInterface template.
- Add Class Header hidden attributes [VBA Attributes](https://vbaplanet.com/attributes.php#:~:text=VBA%20code%20modules%20contain%20attributes,module%20in%20a%20text%20editor.)
  - Add in Class description if required.
  - Add in Rubberduck module description annotation  if required. '@ModuleDescription("")
  - Add in Rubberduck predeclaredId annotation if required. '@PredeclaredId
  - Add in comments? i.e. Generated by etc?
  - Potential issues if class name already exists in project or reserved names?
- Declarations
   - Add Option Explicit
   - Add private variable for Com object being wrapped in the type libary.
   - EG. Private mDateTime As DotNetLib.DateTime
- Add VBA Constructors and Destructors?
  - Private Sub Class_Initialize()
  - Private Sub Class_Terminate()
- Add Class Methods (constructors/factory methods, properties, methods)
  - Create in the order of the ComInterface template.
  - Add Rubberduck description annotation comment if required.
  - Add Method signature. Eg Public Function CreateFromDate(ByVal year as long, ByVal month as Long, ByVal day as Long) As DateTime
     - Parameters all one line or split? Maybe make as a selection option? Initially all one line. Potientially issue for extremely long method signatures.
     - Issue the ComInterface properties returning IDateTime how to determine if require an interface or object?
     - As a quick fix could be manually fixed from generated VBA class.
  - Add hidden method attributes required eg. method description, default property, NewEnum etc.
  - Add Com object reference being wrapped.
      - eg Set CreateFromDate = mDateTime.CreateFromDate(year, month, day)
  - Add Method End
     - Eg.  End Function, End Property, End Sub
5) Write VBA class output to a file with extension ".cls" for the output path obtained. eg. DateTime.cls

Will require to investigate VBA wrappers of objects eg a Collection wrapper to check correct implementation.

Any custom error handling required to be done manually. Maybe by parsing the .Net documentation could extract exceptions for a method?

**Implemented June 8**
- Obtain a type library by path.
- TypeLibInternalWapper
- Document TypeLibInternalWapper.
- Write output basic TypeLibInternalWapper document to an output file.
- Utimately the output will be a VBA Com wrapper class.
- To implement:
    - TypeInfoInternalWapper to obtain TypeInfo for each Com object in the Com library.
        -  TypeLib.FindName Obtain the TypeInfo details for the required Com object
        -  Document the TypeInfoInternalWapper for the required Com object
            - Document Com object properties, methods, events? and implemented interfaces.
   - From TypeInfoInternalWapper obtained for the required Com object
        - VBA class builder
        - Preferrably utilize RubberDuck components which extract an interface for a class or refactor interface to a class with minor modifications.
    

**Utilize [RubberDuck Com Management](https://github.com/rubberduck-vba/Rubberduck](https://github.com/rubberduck-vba/Rubberduck/tree/next/Rubberduck.VBEEditor/ComManagement))**
Items of interest

- [ComReflection](https://github.com/rubberduck-vba/Rubberduck/tree/next/Rubberduck.Parsing/ComReflection)
    - [ComLibraryProvider](https://github.com/rubberduck-vba/Rubberduck/blob/next/Rubberduck.Parsing/ComReflection/ComLibraryProvider.cs)
        - public ITypeLib LoadTypeLibrary(string libraryPath)
    - [is-there-a-way-to-view-com-entries-by-traversing-a-tlb-file-in-net](https://stackoverflow.com/questions/43875454/is-there-a-way-to-view-com-entries-by-traversing-a-tlb-file-in-net) 

- [TypeLibs](https://github.com/rubberduck-vba/Rubberduck/tree/next/Rubberduck.VBEEditor/ComManagement/TypeLibs)

- [TypeLibWrapper.cs](https://github.com/rubberduck-vba/Rubberduck/blob/next/Rubberduck.VBEEditor/ComManagement/TypeLibs/TypeLibWrapper.cs)
    - constructor  internal TypeInfoWrapper(ComTypes.ITypeInfo rawTypeInfo)

- [A dumb container of ITypeInfos.](https://github.com/rubberduck-vba/Rubberduck/blob/next/Rubberduck.VBEEditor/ComManagement/TypeLibs/Utility/SimpleCustomTypeLibrary.cs)

- [LibraryReferencedDeclarationsCollector](https://github.com/rubberduck-vba/Rubberduck/blob/next/Rubberduck.Parsing/ComReflection/LibraryReferencedDeclarationsCollector.cs)
  - IReadOnlyCollection<Declaration> CollectedDeclarations(ReferenceInfo reference)


Things to do

1) Load a type library .tlb into a TypeInfo
    - [ComReflection](https://github.com/rubberduck-vba/Rubberduck/tree/next/Rubberduck.Parsing/ComReflection)
    - [ComLibraryProvider](https://github.com/rubberduck-vba/Rubberduck/blob/next/Rubberduck.Parsing/ComReflection/ComLibraryProvider.cs)
        - public ITypeLib LoadTypeLibrary(string libraryPath)
    - [is-there-a-way-to-view-com-entries-by-traversing-a-tlb-file-in-net](https://stackoverflow.com/questions/43875454/is-there-a-way-to-view-com-entries-by-traversing-a-tlb-file-in-net) 
    - eg DotNetLib.tlb
2) Obtain the required COM object TypeInfo
    - eg DateTime
3) Obtain COM Object Class Info for the required object
    - Class Name
    - Class Description
 4) Obtain Class Properties
    - Poperty Name
    - Get and/or Set
    - Description?
 5) Obtain Class Methods
    
    -Method Name
    
    -Method Description
    
    -Method parameters
    
    -return type
    
    
    

